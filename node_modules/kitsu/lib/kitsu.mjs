import _classCallCheck from'babel-runtime/helpers/classCallCheck';import _createClass from'babel-runtime/helpers/createClass';import axios from'axios';import _regeneratorRuntime from'babel-runtime/regenerator';import _asyncToGenerator from'babel-runtime/helpers/asyncToGenerator';import kebab from'decamelize';import plural from'pluralize';import _typeof from'babel-runtime/helpers/typeof';import camel from'camelcase';var deattribute=function(){var a=_asyncToGenerator(_regeneratorRuntime.mark(function a(b){var c,d=this;return _regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:if(a.prev=0,b.constructor!==Array){a.next=6;break}return a.next=4,b.forEach(function(){var a=_asyncToGenerator(_regeneratorRuntime.mark(function a(c,e){return _regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,deattribute(c);case 2:b[e]=a.sent;case 3:case'end':return a.stop();}},a,d)}));return function(){return a.apply(this,arguments)}}());case 4:a.next=16;break;case 6:if(!(b.attributes&&b.attributes.constructor===Object)){a.next=16;break}return a.next=9,b.attributes;case 9:a.t0=_regeneratorRuntime.keys(a.sent);case 10:if((a.t1=a.t0()).done){a.next=15;break}c=a.t1.value,b[c]=b.attributes[c],a.next=10;break;case 15:delete b.attributes;case 16:return a.abrupt('return',b);case 19:throw a.prev=19,a.t2=a['catch'](0),a.t2;case 22:case'end':return a.stop();}},a,this,[[0,19]])}));return function(){return a.apply(this,arguments)}}(),filterIncludes=function(){var a=_asyncToGenerator(_regeneratorRuntime.mark(function a(b,c){var d=c.id,e=c.type;return _regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.prev=0,a.abrupt('return',b.filter(function(a){return a.id===d&&a.type===e})[0]);case 4:throw a.prev=4,a.t0=a['catch'](0),a.t0;case 7:case'end':return a.stop();}},a,this,[[0,4]])}));return function(){return a.apply(this,arguments)}}(),linkRelationships=function(){var a=_asyncToGenerator(_regeneratorRuntime.mark(function a(b,c){var d,e,f,g,h,i,j,k,l,m,n,o,p;return _regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.prev=0,d=b.relationships,a.next=4,d;case 4:a.t0=_regeneratorRuntime.keys(a.sent);case 5:if((a.t1=a.t0()).done){a.next=61;break}if(e=a.t1.value,!(d[e].data&&d[e].data.constructor===Array)){a.next=48;break}return f=!0,g=!1,h=void 0,a.prev=11,a.next=14,d[e].data;case 14:a.t2=Symbol.iterator,i=a.sent[a.t2]();case 16:if(f=(j=i.next()).done){a.next=32;break}return k=j.value,l=k.id,m=k.type,b[e]||(b[e]=[]),a.t3=b[e],a.t4=deattribute,a.next=24,filterIncludes(c,{id:l,type:m});case 24:return a.t5=a.sent,a.next=27,(0,a.t4)(a.t5);case 27:a.t6=a.sent,a.t3.push.call(a.t3,a.t6);case 29:f=!0,a.next=16;break;case 32:a.next=38;break;case 34:a.prev=34,a.t7=a['catch'](11),g=!0,h=a.t7;case 38:a.prev=38,a.prev=39,!f&&i.return&&i.return();case 41:if(a.prev=41,!g){a.next=44;break}throw h;case 44:return a.finish(41);case 45:return a.finish(38);case 46:a.next=59;break;case 48:if(!d[e].data){a.next=59;break}if(n=d[e].data,o=n.id,p=n.type,b[e]){a.next=58;break}return a.t8=deattribute,a.next=54,filterIncludes(c,{id:o,type:p});case 54:return a.t9=a.sent,a.next=57,(0,a.t8)(a.t9);case 57:b[e]=a.sent;case 58:delete b[e].relationships;case 59:a.next=5;break;case 61:return delete b.relationships,a.abrupt('return',b);case 65:throw a.prev=65,a.t10=a['catch'](0),a.t10;case 68:case'end':return a.stop();}},a,this,[[0,65],[11,34,38,46],[39,,41,45]])}));return function(){return a.apply(this,arguments)}}(),deserialise=function(){var a=_asyncToGenerator(_regeneratorRuntime.mark(function a(b){var c,d,e,f,g,h;return _regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:if(a.prev=0,!(b.data&&b.data.constructor===Array)){a.next=40;break}return c=!0,d=!1,e=void 0,a.prev=5,a.next=8,b.data;case 8:a.t0=Symbol.iterator,f=a.sent[a.t0]();case 10:if(c=(g=f.next()).done){a.next=24;break}if(h=g.value,!b.included){a.next=16;break}return a.next=15,linkRelationships(h,b.included);case 15:h=a.sent;case 16:if(!h.attributes){a.next=20;break}return a.next=19,deattribute(h);case 19:h=a.sent;case 20:b.data[b.data.indexOf(h)]=h;case 21:c=!0,a.next=10;break;case 24:a.next=30;break;case 26:a.prev=26,a.t1=a['catch'](5),d=!0,e=a.t1;case 30:a.prev=30,a.prev=31,!c&&f.return&&f.return();case 33:if(a.prev=33,!d){a.next=36;break}throw e;case 36:return a.finish(33);case 37:return a.finish(30);case 38:a.next=44;break;case 40:if(!b.included){a.next=44;break}return a.next=43,linkRelationships(b.data,b.included);case 43:b.data=a.sent;case 44:if(delete b.included,!b.data.attributes){a.next=49;break}return a.next=48,deattribute(b.data);case 48:b.data=a.sent;case 49:return a.abrupt('return',b);case 52:throw a.prev=52,a.t2=a['catch'](0),a.t2;case 55:case'end':return a.stop();}},a,this,[[0,52],[5,26,30,38],[31,,33,37]])}));return function(){return a.apply(this,arguments)}}();function query(a){try{var b='',c=function(c){'object'===_typeof(a[c])?Object.keys(a[c]).forEach(function(d){b+='&'+c+'['+d+']='+a[c][d]}):'string'==typeof a[c]&&(b+='&'+c+'='+a[c])};for(var d in a)c(d);return a?b.slice(1):''}catch(a){throw a}}var serialise=function(){var a=_asyncToGenerator(_regeneratorRuntime.mark(function a(b){var c,d,e,f=1<arguments.length&&arguments[1]!==void 0?arguments[1]:{},g=2<arguments.length&&arguments[2]!==void 0?arguments[2]:'POST';return _regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:if(a.prev=0,f.constructor===Object&&0!==Object.keys(f).length){a.next=3;break}throw new Error(g+' requires a JSON object body');case 3:if(c=plural(camel(b)),d={type:c},'POST'===g||'undefined'!=typeof f.id){a.next=7;break}throw new Error(g+' requires an ID for the '+c+' type');case 7:for(e in'POST'!==g&&(d.id=f.id),f)null!==f[e]&&f[e].constructor===Object&&('string'==typeof f[e].id||'string'==typeof f[e].type)?('undefined'==typeof d.relationships&&(d.relationships={}),'undefined'==typeof f[e].type&&(f[e].type=plural(camel(e))),d.relationships[e]={data:Object.assign(f[e])}):'id'!==e&&('undefined'==typeof d.attributes&&(d.attributes={}),d.attributes[e]=f[e]);return a.abrupt('return',{data:d});case 12:throw a.prev=12,a.t0=a['catch'](0),a.t0;case 15:case'end':return a.stop();}},a,this,[[0,12]])}));return function(){return a.apply(this,arguments)}}(),create=function(){var a=_asyncToGenerator(_regeneratorRuntime.mark(function a(b,c){var d,f,g;return _regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:if(a.prev=0,this.axios.defaults.headers.Authorization){a.next=3;break}throw new Error('Not logged in');case 3:return a.t0=this.axios,a.t1=plural(kebab(b)),a.next=7,serialise(b,c);case 7:return a.t2=a.sent.data,a.t3=this.headers,a.t4={data:a.t2,headers:a.t3},a.next=12,a.t0.post.call(a.t0,a.t1,a.t4);case 12:return d=a.sent,f=d.data,a.abrupt('return',f);case 17:return a.prev=17,a.t5=a['catch'](0),g=a.t5.response.data,a.abrupt('return',g.errors?g.errors:g);case 21:case'end':return a.stop();}},a,this,[[0,17]])}));return function(){return a.apply(this,arguments)}}(),fetch=function(){var a=_asyncToGenerator(_regeneratorRuntime.mark(function a(b,c){var d,f,g;return _regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.prev=0,a.next=3,this.axios.get(plural(kebab(b)),{params:c,paramsSerializer:function(b){return query(b)},headers:this.headers});case 3:return d=a.sent,f=d.data,a.abrupt('return',deserialise(f));case 8:return a.prev=8,a.t0=a['catch'](0),g=a.t0.response.data,a.abrupt('return',g.errors?g.errors:g);case 12:case'end':return a.stop();}},a,this,[[0,8]])}));return function(){return a.apply(this,arguments)}}(),remove=function(){var a=_asyncToGenerator(_regeneratorRuntime.mark(function a(b,c){var d,f,g;return _regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.prev=0,a.t0=console,a.next=4,serialise(b,{id:c},'DELETE');case 4:if(a.t1=a.sent,a.t0.log.call(a.t0,a.t1),this.axios.defaults.headers.Authorization){a.next=8;break}throw new Error('Not logged in');case 8:return a.t2=this.axios,a.t3=plural(kebab(b))+'/'+c,a.next=12,serialise(b,{id:c},'DELETE');case 12:return a.t4=a.sent.data,a.t5=this.headers,a.t6={data:a.t4,headers:a.t5},a.next=17,a.t2.delete.call(a.t2,a.t3,a.t6);case 17:return d=a.sent,f=d.data,a.abrupt('return',f);case 22:return a.prev=22,a.t7=a['catch'](0),g=a.t7.response.data,a.abrupt('return',g.errors?g.errors:g);case 26:case'end':return a.stop();}},a,this,[[0,22]])}));return function(){return a.apply(this,arguments)}}(),self=function(){var a=_asyncToGenerator(_regeneratorRuntime.mark(function a(b){var c,d;return _regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.prev=0,a.next=3,fetch.bind(this)('users',Object.assign({filter:{self:!0}},b));case 3:return c=a.sent,d=c.data,a.abrupt('return',d[0]);case 8:return a.prev=8,a.t0=a['catch'](0),a.abrupt('return',a.t0);case 11:case'end':return a.stop();}},a,this,[[0,8]])}));return function(){return a.apply(this,arguments)}}(),update=function(){var a=_asyncToGenerator(_regeneratorRuntime.mark(function a(b,c){var d,f,g;return _regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:if(a.prev=0,this.axios.defaults.headers.Authorization){a.next=3;break}throw new Error('Not logged in');case 3:if('undefined'!=typeof c.id){a.next=5;break}throw new Error('Updating a resource requires an ID');case 5:return a.t0=this.axios,a.t1=plural(kebab(b))+'/'+c.id,a.next=9,serialise(b,c,'PATCH');case 9:return a.t2=a.sent.data,a.t3=this.headers,a.t4={data:a.t2,headers:a.t3},a.next=14,a.t0.patch.call(a.t0,a.t1,a.t4);case 14:return d=a.sent,f=d.data,a.abrupt('return',f);case 19:return a.prev=19,a.t5=a['catch'](0),g=a.t5.response.data,a.abrupt('return',g.errors?g.errors:g);case 23:case'end':return a.stop();}},a,this,[[0,19]])}));return function(){return a.apply(this,arguments)}}(),kitsu='https://kitsu.io/api',Kitsu=function(){function a(){var b=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};_classCallCheck(this,a),this.fetch=fetch.bind(this),this.update=update.bind(this),this.create=create.bind(this),this.remove=remove.bind(this),this.self=self.bind(this),this.get=this.fetch,this.find=this.fetch,this.findAll=this.fetch,this.patch=this.update,this.post=this.create,this.destroy=this.remove,this.whoAmI=this.self,this.baseURL=b.baseURL||kitsu,this.headers=Object.assign(b.headers?b.headers:{},{accept:'application/vnd.api+json',"content-type":'application/vnd.api+json'}),this.axios=axios.create({baseURL:this.baseURL+'/'+(b.version||this.baseURL===kitsu?'edge':''),timeout:b.timeout||3e4,headers:this.headers})}return _createClass(a,[{key:'headers',value:function(){return this.headers}},{key:'isAuth',get:function(){return'undefined'!=typeof this.headers.authorization}}]),a}();export default Kitsu;
